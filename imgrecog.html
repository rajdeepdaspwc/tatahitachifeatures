<!DOCTYPE html>
<html>
<head>
	<title>Tata Hitachi Image Recognition</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta name="theme-color" content="#317EFB"/>
		<link rel="Shortcut Icon" type="image/x-icon" href="https://www.tatahitachi.co.in/favicon.ico" />
	<title></title>
  <style>
    .start, .stop{
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translate(-50%, 0);
      display: none;
      font-weight:bold;
      padding:12px 35px;
      border:none;
      border-radius: 30px;
      font-size: 25px;
      outline: none;
    }
    .start{
      background-color: rgb(58, 209, 38);
      color:#fff;
      
    }
    .stop{
      background-color: rgb(238, 11, 4);
      color:#fff;
    }
    .analyze-loader, .detection-result{
      position: absolute;
      bottom: 150px;
      left: 50%;
      transform: translate(-50%, 0);
      display: none;
    }
    .analyze-loader span{
      padding-bottom: 7px;
      display: block;
      text-align: center;
      color:#fff;
      font-family: "Arial";
    }
    .detection-result{
      min-width: 320px;
      font-size:30px;
      color:#fff;
      font-family: "Arial";
    }
  </style>
</head>
<body>
<!-- <button onclick="changeURL()">URL</button> -->
<!-- <div>Teachable Machine Image Model - p5.js and ml5.js</div> -->

<button class="start" onclick="startClassify()">Start Analyzing</button>
<button class="stop" onclick="stopClassify()">Stop Analyzing</button>

<div class="analyze-loader">
  <br>
  <span>Analyzing ...</span>
  <img src="./assets/gif/loading.gif" alt="" width="120">
</div>
<div class="detection-result"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

<style>body{margin: 15px; text-align: center; background-color: #101010; user-select: none;} .p5Canvas{display: inline-block;}</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">


  // function changeURL(){
  //   window.parent.location.href = "https://www.google.com";
  // }

  var classifyImage = false;

  var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return typeof sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
          return false;
      };

        function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

  // Classifier Variable
  let classifier;
  // Model URL
  let imageModelURL = './imgrecog/models/' + getUrlParameter("type") + '/';
  
  // Video
  let video;
  let flippedVideo;
  // To store the classification
  let label = "";

  // Load the model first
  function preload() {
    classifier = ml5.imageClassifier(imageModelURL + 'model.json', function(){
      $(".start").css("display", "block");
    });
  }

  function setup() {
    createCanvas(380, 500);
    // Create the video
    video = createCapture({
    audio: false,
  // video: true
    video: {
      facingMode: {
        exact: "environment"
      }
    }
  });
    video.size(380, 500);
    video.hide();

    flippedVideo = ml5.flipImage(video);
    // Start classifying
    classifyVideo();
  }

  function draw() {
    background(0);
    // Draw the video
   image(video, 0, 0);

    // Draw the label
    fill(255);
    textSize(32);
    textAlign(CENTER);
    text(label, width / 2, height - 10);
  }

  // Get a prediction for the current video frame
  function classifyVideo() {
   // flippedVideo = ml5.flipImage(video)
    
      classifier.classify(video, gotResult);
      video.remove();
    

  }

  function startClassify(){
    classifyImage = true;
    $(".stop").css("display", "block");
    $(".start").css("display", "none");
    $(".analyze-loader").show();
    $(".detection-result").hide().text("");
  }
  function stopClassify(){
    classifyImage = false;
    $(".stop").css("display", "none");
    $(".start").css("display", "block");
    $(".analyze-loader").hide();
    label = "";
  }

  // When we get a result
  function gotResult(error, results) {

    if(classifyImage){

    // If there is an error
    if (error) {
      console.error(error);
      return;
    }

    
    //console.log(results);
    // The results are in an array ordered by confidence.
    // console.log(results[0]);
   // label = results[0].label + " " + results[0].confidence.toFixed(2);
    // Classifiy again!

    

    if(getUrlParameter("mode") === "percent"){
     // label = "Analyzingg...";
      //alert(getUrlParameter("mode"))
      label = results[0].label +" : "+ (results[0].confidence * 100).toFixed(2)+"%";
    }else{
     // label = "Analyzing...";

      
      if(results[0].confidence.toFixed(2) >= .98){
        stopClassify();
        //alert(results[0].label);
      }
    }

   // label = "Analyzingg...";

    if(results[0].confidence.toFixed(2) >= .98){
    //alert(results[0].label);

    //label = capitalizeFirstLetter(results[0].label) + " is detected";
    $(".detection-result").text(capitalizeFirstLetter(results[0].label) + " was detected.").show();
    }
      console.log("asd");
  }
    
    classifyVideo();

    
    
  }

//alert("HOLAa");

  /*  ################# ############# */

  // function setup(){
  //  createCanvas(640, 480);
  //  background(0);
  // }

</script>

</body>
</html>